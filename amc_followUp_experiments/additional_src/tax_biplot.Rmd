---
title: "tax_biplot"
output: github_document
date: "2024-06-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

TO DO:
- fix the legend labels for the diets
- mess around with different alphas for transparency 

```{r}
library(rmarkdown)
library(ggpubr)
library(ggplot2)
library(qiime2R)
library(tidyverse)
library(ggh4x)
library(viridis)
library(ggrepel)
library(rstatix)
library(ape)
library(vegan)
```

**Functions**
```{r}
## for distance matrix processing
## for beta diversity statistical analysis 
dist_matrix_prep <- function(metadata_fp,
                             dist_matrix_fp){
  ## metadata
  metadata <- read_tsv(metadata_fp) %>% 
            rename(sampleid = `#SampleID`)
  ## distance matrix
  dist <- read_tsv(dist_matrix_fp)
  names(dist)[names(dist) == '...1'] <- 'sampleid'
  dist %>% 
    gather(-sampleid, key = sample_col, value = dist) %>% 
    filter(sampleid %in% metadata$sampleid) %>% 
    filter(sample_col %in% metadata$sampleid) %>% 
    spread(sample_col, dist) -> dist_long
  dist_long %>% 
    select(-sampleid) -> dist_proc
  metadata %>% 
    arrange(sampleid) -> metadata
  metadata %>% 
    filter(sampleid %in% dist_long$sampleid) -> filt_meta
  dist_proc <- as.matrix(dist_proc)
  row.names(dist_proc) <- colnames(dist_proc)
  filt_meta <- filt_meta[order(filt_meta$sampleid),]
  ## list of outputs
  my_list <- list(Metadata = filt_meta,
                  DistanceMatrix = dist_proc)
  return(my_list)
}


## beta diversity adonis2 testing function
adonis_test <- function(dist_matrix,
                        formula,
                        wanted_strata = NULL,
                        adonis_by = NULL,
                        metadata_file){
  my_dist_matrix <- as.dist(dist_matrix)
  funky_formula <- paste("my_dist_matrix", formula, sep = "~")
  print(funky_formula)
  adonis_results <- adonis2(as.formula(funky_formula),
                            data = metadata_file,
                            permutations = 999, 
                            parallel = 4,
                            strata = wanted_strata,
                            by = adonis_by)
  adonis_results <- tidy(adonis_results)
  adonis_results['signif'] <- symnum(adonis_results$p.value,
                                     cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
                                     symbols = c("****", "***", "**", "*", "+", "ns"),
                                     abbr.colnames = FALSE,
                                     na = "")
  return(adonis_results)
}


prep_my_biplot_files <- function(biplot_fp,
                                 metadata_fp,
                                 tax_fp,
                                 parse_tax = TRUE,
                                 top_tax_n,
                                 dist_pc_axis,
                                 lines_longer_by){
  
  ## reading in file and extracting needed elements for plot
  pcoa_var <- read_qza(biplot_fp)$data$ProportionExplained
  ## for the points on plot
  biplot_points <- read_qza(biplot_fp)$data$Vectors
  ## for the lines w arrows on plot
  biplot_lines <- read_qza(biplot_fp)$data$Species
  
  ## metadata and taxonomy
  meta <- read_tsv(metadata_fp) %>% 
            rename(sampleid = `#SampleID`)
  
  ifelse(parse_tax == TRUE, 
         taxonomy <- read_qza(tax_fp)$data %>% 
                      parse_taxonomy() %>%
                      rownames_to_column('asv'),
         taxonomy <- read_qza(tax_fp)$data %>% 
                      rename(asv = Feature.ID)
         )
  ## some data wrangling wooo
  biplot_points <- biplot_points %>% 
                      rename(sampleid = SampleID) %>% 
                      select(sampleid, PC1, PC2, PC3, PC4) %>% 
                      left_join(meta, by = 'sampleid')
  
  biplot_lines <- biplot_lines %>% 
                        mutate(dist_origin1to2 = sqrt(PC1^2 + PC2^2),
                               dist_origin2to3 = sqrt(PC2^2 + PC3^2),
                               dist_origin3to4 = sqrt(PC3^2 + PC4^2)) %>% 
                        slice_max(.data[[dist_pc_axis]], n = top_tax_n) %>% 
                        mutate(PC1 = (PC1 * 0.3)*lines_longer_by,
                               PC2 = (PC2 * 0.3)*lines_longer_by,
                               PC3 = (PC3 * 0.3)*lines_longer_by,
                               PC4 = (PC4 * 0.3)*lines_longer_by,) %>% 
                        rename(asv = FeatureID) %>% 
                        select(asv, PC1, PC2, PC3, PC4) %>% 
                        left_join(taxonomy, by = 'asv') 
  
  ## list of outputs
  my_list <- list(PCvar = pcoa_var,
                  DFPoints = biplot_points,
                  DFLines = biplot_lines,
                  Metadata = meta,
                  Taxonomy = taxonomy)
  return(my_list)
}

## takes the axis variance and makes it into a label for you so you don't
## have to do it every time 
pcoa_ax_lab <- function(unifrac_var, col_name){
  uni_lab <- as.character(round(unifrac_var[col_name] * 100, 2))
  uni_lab <- paste0(col_name, ' - ', uni_lab, '%')
  return(uni_lab)
}

## function for making the actual plot
make_my_biplot <- function(x_axis,
                           y_axis,
                           points_df,
                           points_color = NULL,
                           points_shape,
                           points_alpha,
                           color_name,
                           shape_labels,
                           color_labels,
                           lines_df,
                           lines_label,
                           lines_label_size,
                           x_name,
                           y_name,
                           shape_name,
                           alpha_name,
                           title_content){
     if (is.character(points_color)){ 
         plot <- ggplot() +
                  geom_jitter(data = points_df,
                             aes(x = .data[[x_axis]], y = .data[[y_axis]], 
                                 fill = .data[[points_color]],
                                 shape = .data[[points_shape]],
                                 alpha = .data[[points_alpha]]),
                             size = 5) +
                  scale_shape_manual(values = c(21, 24),
                                     labels = shape_labels) +
                  scale_fill_viridis(option = "C",
                                     discrete = TRUE,
                                     labels = color_labels) +
                  scale_alpha_manual(values = c(0.4, 0.8)) +
                  guides(fill = guide_legend(override.aes = list(shape = 21,
                                                                 alpha = 1)),
                         shape = guide_legend(override.aes = list(fill = "black")),
                         alpha = guide_legend(override.aes = list(color = 'black'))) +
                  theme_bw(base_size = 20) +
                  geom_segment(data = lines_df,
                               aes(x = 0, xend = .data[[x_axis]], y = 0, yend = .data[[y_axis]]),
                               arrow = arrow(length = unit(0.3, "cm"))) +
                  geom_text_repel(data = lines_df,
                                  aes(x = .data[[x_axis]], y = .data[[y_axis]], label = .data[[lines_label]]),
                                  color = 'black',
                                  # position = 'jitter',
                                  size = lines_label_size,
                                  direction = "both",
                                  fontface = 'bold') +
                  labs(x = x_name,
                       y = y_name,
                       fill = color_name,
                       shape = shape_name,
                       alpha = alpha_name,
                       title = title_content) 
     } else {
         plot <- ggplot() +
                  geom_jitter(data = points_df,
                             aes(x = .data[[x_axis]], y = .data[[y_axis]],
                                 shape = .data[[points_shape]]),
                             size = 5,
                             alpha = 0.5) +
                  scale_shape_discrete(labels = shape_labels) +
                  theme_bw(base_size = 20) +
                  geom_segment(data = lines_df,
                               aes(x = 0, xend = .data[[x_axis]], y = 0, yend = .data[[y_axis]],
                                   color = .data[[lines_label]]),
                               arrow = arrow(length = unit(0.3, "cm")),
                               linewidth = 1.5) +
                  scale_color_viridis(option = 'C', 
                                      discrete = TRUE) +
                  labs(x = x_name,
                       y = y_name,
                       color = color_name,
                       shape = shape_name,
                       title = title_content)
     }
  
  return(plot)
}
```

**File Paths**
```{r}
metadata_FP <- '../data/misc/proc_newExp_d15-d3_metadata.tsv'
cfu_count_FP <- '../data/misc/proc_combined_CDD_cfuCounts.tsv'
tax_FP <- '../data/qiime/taxonomy.qza'
uu_biplot_FP <- '../data/qiime/core_outputs/uu_biplot_matrix.qza'
uu_dist_FP <- '../data/qiime/core_outputs/uw_dist_matrix.tsv'
wu_biplot_FP <- '../data/qiime/core_outputs/wu_biplot_matrix.qza'
wu_dist_FP <- '../data/qiime/core_outputs/w_dist_matrix.tsv'

vendor_labs <- c('Charles River',
                 'Taconic')
diet_legend_labs <- c('Chow',
                      'HFt / HFb',
                      'HFt / LFb',
                      'LFt / HFb',
                      'LFt / LFb')
```

pull out eigenvals? eigenvals greater than one indicate that an axis is significant
```{r}
uu_biplot_eigVals <- read_qza(uu_biplot_FP)$data$Eigvals
```

**Adonis test for significance of independent variables**
adonis tests (sequentially) for significant variation accounted for by each variable in the biplot
```{r}
## prepping distance matrices and metadata for adonis test
uu_dist <- dist_matrix_prep(metadata_fp = metadata_FP,
                 dist_matrix_fp = uu_dist_FP)$DistanceMatrix
wu_dist <- dist_matrix_prep(metadata_fp = metadata_FP,
                 dist_matrix_fp = wu_dist_FP)$DistanceMatrix

dist_meta <- dist_matrix_prep(metadata_fp = metadata_FP,
                 dist_matrix_fp = uu_dist_FP)$Metadata

## running adonis test sequentially (assess significance of each term from first to last)
(uu_adonis_res <- adonis_test(dist_matrix = uu_dist,
                             formula = '(day_post_inf * vendor * diet)',
                             wanted_strata = NULL,
                             adonis_by = "terms",
                             metadata_file = dist_meta))
(wu_adonis_res <- adonis_test(dist_matrix = wu_dist,
                             formula = 'day_post_inf * vendor * diet',
                             wanted_strata = NULL,
                             adonis_by = "terms",
                             metadata_file = dist_meta))
```

# **PC1 and PC2**
**Data Wrangling**
```{r}
## unweighted unifrac
uu_files <- prep_my_biplot_files(biplot_fp = uu_biplot_FP,
                                 metadata_fp = metadata_FP,
                                 tax_fp = tax_FP,
                                 parse_tax = TRUE,
                                 top_tax_n = 15,
                                 dist_pc_axis = 'dist_origin1to2',
                                 lines_longer_by = 4)

uu_biplot_points <- uu_files$DFPoints %>% 
  # mutate(day_post_inf_num = as.numeric(day_post_inf))
  convert_as_factor(day_post_inf)

uu_biplot_lines <- uu_files$DFLines %>% 
  mutate(tax_line_label = ifelse(is.na(Species), Genus, Species),
         tax_line_label = ifelse(is.na(tax_line_label), Family, tax_line_label))


uu_pcoa_var <- uu_files$PCvar

## making x and y axis labels
uu_x_lab <- pcoa_ax_lab(unifrac_var = uu_pcoa_var,
                        col_name = 'PC1')
uu_y_lab <- pcoa_ax_lab(unifrac_var = uu_pcoa_var,
                        col_name = 'PC2')
```

```{r}
## weighted unifrac 
wu_files <- prep_my_biplot_files(biplot_fp = wu_biplot_FP,
                                 metadata_fp = metadata_FP,
                                 tax_fp = tax_FP,
                                 parse_tax = TRUE,
                                 top_tax_n = 15,
                                 dist_pc_axis = 'dist_origin1to2',
                                 lines_longer_by = 12)

wu_biplot_points <- wu_files$DFPoints %>% 
  # mutate(day_post_inf_num = as.numeric(day_post_inf))
  convert_as_factor(day_post_inf)

wu_biplot_lines <- wu_files$DFLines %>% 
  mutate(tax_line_label = ifelse(is.na(Species), Genus, Species),
         tax_line_label = ifelse(is.na(tax_line_label), Family, tax_line_label))
wu_pcoa_var <- wu_files$PCvar

## making x and y axis labels
wu_x_lab <- pcoa_ax_lab(unifrac_var = wu_pcoa_var,
                        col_name = 'PC1')
wu_y_lab <- pcoa_ax_lab(unifrac_var = wu_pcoa_var,
                        col_name = 'PC2')
```

**Plots**
```{r, fig.width=15, fig.height=10}
## unweighted unifrac 
uu_biplot <- make_my_biplot(x_axis = 'PC1',
                            y_axis = 'PC2',
                            points_color = 'diet', ## default is NULL so technically dont have to include
                            points_df = uu_biplot_points,
                            points_shape = 'vendor',
                            points_alpha = 'day_post_inf',
                            color_name = 'Diet',
                            shape_labels = vendor_labs,
                            color_labels = diet_legend_labs,
                            lines_df = uu_biplot_lines,
                            lines_label = 'tax_line_label',
                            lines_label_size = 5.5,
                            x_name = uu_x_lab,
                            y_name = uu_y_lab,
                            shape_name = 'Vendor',
                            alpha_name = 'Days Relative\nto Infection',
                            title_content = 'PC1-PC2: Unweighted UniFrac Biplot')

## weighted unifrac
wu_biplot <- make_my_biplot(x_axis = 'PC1',
                            y_axis = 'PC2',
                            points_df = wu_biplot_points,
                            points_color = 'diet',
                            points_shape = 'vendor',
                            points_alpha = 'day_post_inf',
                            color_name = 'Diet',
                            shape_labels = vendor_labs,
                            color_labels = diet_legend_labs,
                            lines_df = wu_biplot_lines,
                            lines_label = 'tax_line_label',
                            lines_label_size = 5.5,
                            x_name = wu_x_lab,
                            y_name = wu_y_lab,
                            shape_name = 'Vendor',
                            alpha_name = 'Days Relative\nto Infection',
                            title_content = 'PC1-PC2: Weighted UniFrac Biplot')

uu_biplot
wu_biplot
```

# **PC2 and PC3**
**Data Wrangling**
```{r}
## unweighted unifrac
uu_files2_3 <- prep_my_biplot_files(biplot_fp = uu_biplot_FP,
                                 metadata_fp = metadata_FP,
                                 tax_fp = tax_FP,
                                 parse_tax = TRUE,
                                 top_tax_n = 15,
                                 dist_pc_axis = 'dist_origin2to3',
                                 lines_longer_by = 4)

uu_biplot_points2_3 <- uu_files2_3$DFPoints %>% 
                      convert_as_factor(day_post_inf)

uu_biplot_lines2_3 <- uu_files2_3$DFLines %>% 
  mutate(tax_line_label = ifelse(is.na(Species), Genus, Species),
         tax_line_label = ifelse(is.na(tax_line_label), Family, tax_line_label))

uu_pcoa_var2_3 <- uu_files2_3$PCvar

## making x and y axis labels
uu_x_lab2_3 <- pcoa_ax_lab(unifrac_var = uu_pcoa_var2_3,
                           col_name = 'PC2')
uu_y_lab2_3 <- pcoa_ax_lab(unifrac_var = uu_pcoa_var2_3,
                           col_name = 'PC3')
```

```{r}
## weighted unifrac 
wu_files2_3 <- prep_my_biplot_files(biplot_fp = wu_biplot_FP,
                                   metadata_fp = metadata_FP,
                                   tax_fp = tax_FP,
                                   parse_tax = TRUE,
                                   top_tax_n = 15,
                                   dist_pc_axis = 'dist_origin2to3',
                                   lines_longer_by = 9)

wu_biplot_points2_3 <- wu_files2_3$DFPoints %>% 
                        convert_as_factor(day_post_inf)

wu_biplot_lines2_3 <- wu_files2_3$DFLines %>% 
  mutate(tax_line_label = ifelse(is.na(Species), Genus, Species),
         tax_line_label = ifelse(is.na(tax_line_label), Family, tax_line_label))

wu_pcoa_var2_3 <- wu_files2_3$PCvar

## making x and y axis labels
wu_x_lab2_3 <- pcoa_ax_lab(unifrac_var = wu_pcoa_var2_3,
                           col_name = 'PC2')
wu_y_lab2_3 <- pcoa_ax_lab(unifrac_var = wu_pcoa_var2_3,
                           col_name = 'PC3')
```

**Plots**
```{r, fig.width=15, fig.height=10}
## unweighted unifrac 
uu_biplot2_3 <- make_my_biplot(x_axis = 'PC2',
                              y_axis = 'PC3',
                              points_df = uu_biplot_points2_3,
                              points_color = 'diet',
                              points_shape = 'vendor',
                              points_alpha = 'day_post_inf',
                              color_name = 'Diet',
                              shape_labels = vendor_labs,
                              color_labels = diet_legend_labs,
                              lines_df = uu_biplot_lines2_3,
                              lines_label = 'tax_line_label',
                              lines_label_size = 5.5,
                              x_name = uu_x_lab2_3,
                              y_name = uu_y_lab2_3,
                              shape_name = 'Vendor',
                              alpha_name = 'Days Relative\nto Infection',
                              title_content = 'PC2-PC3: Unweighted UniFrac Biplot')

## weighted unifrac
wu_biplot2_3 <- make_my_biplot(x_axis = 'PC2',
                              y_axis = 'PC3',
                              points_df = wu_biplot_points2_3,
                              points_color = 'diet',
                              points_shape = 'vendor',
                              points_alpha = 'day_post_inf',
                              color_name = 'Diet',
                              shape_labels = vendor_labs,
                              color_labels = diet_legend_labs,
                              lines_df = wu_biplot_lines2_3,
                              lines_label = 'tax_line_label',
                              lines_label_size = 5.5,
                              x_name = wu_x_lab2_3,
                              y_name = wu_y_lab2_3,
                              shape_name = 'Vendor',
                              alpha_name = 'Days Relative\nto Infection',
                              title_content = 'PC2-PC3: Weighted UniFrac Biplot')

uu_biplot2_3
wu_biplot2_3
```

# **PC3 and PC4**
**Data Wrangling**
```{r}
## unweighted unifrac
uu_files3_4 <- prep_my_biplot_files(biplot_fp = uu_biplot_FP,
                                 metadata_fp = metadata_FP,
                                 tax_fp = tax_FP,
                                 parse_tax = TRUE,
                                 top_tax_n = 15,
                                 dist_pc_axis = 'dist_origin3to4',
                                 lines_longer_by = 2)

uu_biplot_points3_4 <- uu_files3_4$DFPoints %>% 
                      convert_as_factor(day_post_inf)

uu_biplot_lines3_4 <- uu_files3_4$DFLines %>% 
  mutate(tax_line_label = ifelse(is.na(Species), Genus, Species),
         tax_line_label = ifelse(is.na(tax_line_label), Family, tax_line_label))

uu_pcoa_var3_4 <- uu_files3_4$PCvar

## making x and y axis labels
uu_x_lab3_4 <- pcoa_ax_lab(unifrac_var = uu_pcoa_var3_4,
                           col_name = 'PC3')
uu_y_lab3_4 <- pcoa_ax_lab(unifrac_var = uu_pcoa_var3_4,
                           col_name = 'PC4')
```

```{r}
## weighted unifrac 
wu_files3_4 <- prep_my_biplot_files(biplot_fp = wu_biplot_FP,
                                   metadata_fp = metadata_FP,
                                   tax_fp = tax_FP,
                                   parse_tax = TRUE,
                                   top_tax_n = 15,
                                   dist_pc_axis = 'dist_origin3to4',
                                   lines_longer_by = 4)

wu_biplot_points3_4 <- wu_files3_4$DFPoints %>% 
                        convert_as_factor(day_post_inf)

wu_biplot_lines3_4 <- wu_files3_4$DFLines %>% 
  mutate(tax_line_label = ifelse(is.na(Species), Genus, Species),
         tax_line_label = ifelse(is.na(tax_line_label), Family, tax_line_label))

wu_pcoa_var3_4 <- wu_files3_4$PCvar

## making x and y axis labels
wu_x_lab3_4 <- pcoa_ax_lab(unifrac_var = wu_pcoa_var3_4,
                           col_name = 'PC3')
wu_y_lab3_4 <- pcoa_ax_lab(unifrac_var = wu_pcoa_var3_4,
                           col_name = 'PC4')
```

**Plots**
```{r, fig.width=15, fig.height=10}
## unweighted unifrac 
uu_biplot3_4 <- make_my_biplot(x_axis = 'PC3',
                              y_axis = 'PC4',
                              points_df = uu_biplot_points3_4,
                              points_color = 'diet',
                              points_shape = 'vendor',
                              points_alpha = 'day_post_inf',
                              color_name = 'Diet',
                              shape_labels = vendor_labs,
                              color_labels = diet_legend_labs,
                              lines_df = uu_biplot_lines3_4,
                              lines_label = 'tax_line_label',
                              lines_label_size = 5.5,
                              x_name = uu_x_lab3_4,
                              y_name = uu_y_lab3_4,
                              shape_name = 'Vendor',
                              alpha_name = 'Days Relative\nto Infection',
                              title_content = 'PC3-PC4: Unweighted UniFrac Biplot')

## weighted unifrac
wu_biplot3_4 <- make_my_biplot(x_axis = 'PC3',
                              y_axis = 'PC4',
                              points_df = wu_biplot_points3_4,
                              points_color = 'diet',
                              points_shape = 'vendor',
                              points_alpha = 'day_post_inf',
                              color_name = 'Diet',
                              shape_labels = vendor_labs,
                              color_labels = diet_legend_labs,
                              lines_df = wu_biplot_lines3_4,
                              lines_label = 'tax_line_label',
                              lines_label_size = 5.5,
                              x_name = wu_x_lab3_4,
                              y_name = wu_y_lab3_4,
                              shape_name = 'Vendor',
                              alpha_name = 'Days Relative\nto Infection',
                              title_content = 'PC3-PC4: Weighted UniFrac Biplot')

uu_biplot3_4
wu_biplot3_4
```

# **Saving my Outputs**

```{r}
## as a .pdf
ggsave('../plots/uu_biplot1_2.pdf',
       plot = uu_biplot,
       width = 15,
       height = 10)
ggsave('../plots/wu_biplot1_2.pdf',
       plot = wu_biplot,
       width = 15,
       height = 10)
ggsave('../plots/uu_biplot2_3.pdf',
       plot = uu_biplot2_3,
       width = 15,
       height = 10)
ggsave('../plots/wu_biplot2_3.pdf',
       plot = wu_biplot2_3,
       width = 15,
       height = 10)
ggsave('../plots/uu_biplot3_4.pdf',
       plot = uu_biplot3_4,
       width = 15,
       height = 10)
ggsave('../plots/wu_biplot3_4.pdf',
       plot = wu_biplot3_4,
       width = 15,
       height = 10)

## as an .rdat object 
save(uu_biplot,
     file = '../../figures/uu_biplot_pc1to2.rdat')
save(wu_biplot,
     file = '../../figures/wu_biplot_pc1to2.rdat')
save(uu_biplot2_3,
     file = '../../figures/uu_biplot_pc2to3.rdat')
save(wu_biplot2_3,
     file = '../../figures/wu_biplot_pc2to3.rdat')
```






