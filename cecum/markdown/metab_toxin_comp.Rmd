---
title: "metab_toxin_comp"
output: html_document
date: "2023-09-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(broom)
library(cowplot)
library(magrittr)
library(qiime2R)
library(tidyverse)
library(naniar)
library(ggpubr)
library(rstatix)
library(viridis)
```

**Functions**
```{r}
## correlation plot function
comp_plot <- function(metab_table,
                      ## toxin or metabolomics?
                       wanted_table,
                       ## this is what you want your x axis to be (neat, diluted, or concentration)? 
                       wanted_x,
                       ## this is toxin/metabolite column you want to filter by (neat or diluted)?
                       wanted_y,
                       ## what is the toxin/metabolite you want to filter by called in the table?
                       wanted_y_name,
                       diet_labels,
                       tox_labels,
                       title){
  ## putting tables together
  metab_table %>% 
    select(mouse_id, metabolite, metab_conc_norm) %>% 
    left_join(wanted_table, by = 'mouse_id') %>% 
    na.omit() -> compiled_table
  ## constructing plot
  compiled_table %>% 
    filter(.data[[wanted_y]] == wanted_y_name) %>% 
    na.omit() %>% 
    ggplot(aes(x = .data[[wanted_x]], y = metab_conc_norm)) +
    scale_x_continuous(trans = 'log10') +
    scale_y_continuous(trans = 'log10') +
    geom_jitter(alpha = 0.4, width = 0.1, height = 0) +
    geom_smooth(method = 'lm', se = FALSE) +
    facet_grid(neat_toxin~diet,
               labeller = labeller(neat_toxin = tox_labels,
                                   diet = diet_labels),
               scales = 'free_y') +
    theme_bw() +
    theme(strip.text.y = element_text(angle = 0)) +
    xlab('Toxin Concentration') +
    ylab('Metabolite Concentration (ug/g)') +
    ggtitle(title) -> plot
  return(plot)
}

## runs linear modeling on the table, diet, location, and toxin/metabolite wanted and returns full results 
## along with a table containing the r2 and p-value 
## this goes into the following function with a for loop 
r2_value <- function(biom_table,
                     wanted_diet,
                     wanted_metab,
                     tox_col,
                     wanted_tox,
                     wanted_conc_value){
  ## to get r squared value and p value
  biom_table %>% 
    filter(diet == wanted_diet,
           metabolite == wanted_metab,
           .data[[tox_col]] == wanted_tox) %>% 
    do(glance(lm(metab_conc_norm ~ .data[[wanted_conc_value]],
                 data = .))) -> lm_glance
  output <- list(r_squared = lm_glance$r.squared,
                 p_value = lm_glance$p.value)
  ## to get estimate and place it with the overall output table
  biom_table %>% 
    filter(diet == wanted_diet,
           metabolite == wanted_metab,
           .data[[tox_col]] == wanted_tox) %>% 
    do(tidy(lm(metab_conc_norm ~ .data[[wanted_conc_value]],
                 data = .))) %>% 
    filter(term != '(Intercept)') -> lm_full
  output <- as_tibble(output) %>%
            mutate(diet = paste(wanted_diet),
                   metabolite = paste(wanted_metab),
                   toxin = paste(wanted_tox),
                   just_r = sqrt(r_squared),
                   estimate = lm_full$estimate,
                   r_direct = if_else(estimate < 0, just_r * -1, just_r))
  my_list <- list(LinearModel = lm_full,
                  WantedStats = output)
  return(my_list)
}

## creating a nested for loop since running this function individually is a nightmare
r2_value_for_loop <- function(biom_table,
                              wanted_col,
                              wanted_conc) {
  ## nested for loop for the r squared and p values 
  output <- tibble()
  for(i in unique(unlist(biom_table$diet))) {
    for(j in unique(unlist(biom_table$metabolite))) {
      for(k in unique(unlist(biom_table[wanted_col]))) {
        tmp_output <- r2_value(biom_table,
                               i,
                               j,
                               wanted_col,
                               k,
                               wanted_conc)$WantedStats
        output <- bind_rows(output, tmp_output)
      }
    }
  }
  return(output)
}

## statistical visualization plot function
stat_plot <- function(stat_table,
                      wanted_labels,
                      title){
  stat_table %>% 
    ggplot(aes(x = toxin, y = diet)) +
    geom_tile(aes(fill = r_direct), color = 'black', alpha = 0.6) +
    geom_text(aes(label = signif)) +
    scale_fill_gradient2(low = 'blue', high = 'green', name = "Correlation\nCoefficient") +
    scale_x_discrete(labels = c("TcdA",
                                "TcdB")) +
    scale_y_discrete(labels = c("Chow",
                                "HFt/HFb",
                                "HFt/LFb",
                                "LFt/HFb",
                                "LFt/LFb")) +
    facet_wrap(~metabolite,
               labeller = labeller(metabolite = wanted_labels)) +
    theme_bw() +
    xlab("Toxin") +
    ylab("Diet") +
    ggtitle(title) -> plot
  return(plot)
  }
```

**File Paths**
```{r}
## reading in processed files so I don't have to reprocess them again
metadata_FP <- '../data/misc/filt_cecal_processed_metadata.tsv'
metab_FP <- '../data/misc/processed_metabolomics.tsv'
toxin_FP <- '../data/misc/processed_neatToxin.tsv'

## lists to redo the diet names on the facet labels of the ggplot created below 
diet_labs <- 
    c('Chow', 
      'High Fat / High Fiber', 
      'High Fat / Low Fiber', 
      'Low Fat / High Fiber', 
      'Low Fat / Low Fiber')

names(diet_labs) <- c('Chow', 'HF/HF', 'HF/LF', 'LF/HF', 'LF/LF')

wanted_metabs <- c('Acetic Acid (ug/g)',
                   'Propanoic Acid (ug/g)',
                   'n-Butanoic Acid (ug/g)')
metab_labs <- c('Acetic Acid',
                'Propanoic Acid',
                'n-Butanoic Acid')
names(metab_labs) <- wanted_metabs

neat_labs <- c('TcdA', 'TcdB')
names(neat_labs) <- c('Total TcA Neat', 'Total TcB Neat')
```

**File Prep**
```{r}
metadata <- read_tsv(metadata_FP)
metab <- read_tsv(metab_FP)
neat_toxin <- read_tsv(toxin_FP)

## adding two so that I don't have any zeroes 
## zeroes get cut off on the plot since I have the axis in log10
metab %>% 
  mutate(metab_conc_norm = (concentration + 2)) -> metab
neat_toxin %>% 
  mutate(neat_conc_norm = (neat_conc + 2)) -> neat_toxin
```

**Comparison Plots**
Acetic Acid
```{r, warning=FALSE, fig.height=4, fig.width=10}
tox_acetic <- comp_plot(metab,
                        neat_toxin,
                        "neat_conc_norm",
                        "metabolite",
                        "Acetic Acid (ug/g)",
                        diet_labs,
                        neat_labs,
                        "Acetic Acid")
tox_acetic
```

n-Butanoic Acid
```{r, warning=FALSE, fig.height=4, fig.width=10}
tox_butanoic <- comp_plot(metab,
                        neat_toxin,
                        "neat_conc_norm",
                        "metabolite",
                        "n-Butanoic Acid (ug/g)",
                        diet_labs,
                        neat_labs,
                        "n-Butanoic Acid")
tox_butanoic
```

Propanoic Acid 
```{r, warning=FALSE, fig.height=4, fig.width=10}
tox_propanoic <- comp_plot(metab,
                            neat_toxin,
                            "neat_conc_norm",
                            "metabolite",
                            "Propanoic Acid (ug/g)",
                            diet_labs,
                            neat_labs,
                            "Propanoic Acid")
tox_propanoic
```

**Statistical Analysis**
```{r}
metab %>% 
    select(mouse_id, metabolite, metab_conc_norm) %>% 
    left_join(neat_toxin, by = 'mouse_id') %>% 
    na.omit() %>% 
    ungroup() -> metab_tox

stat_table <- r2_value_for_loop(metab_tox,
                                "neat_toxin",
                                "neat_conc_norm")
## assigning p value significance
stat_table['signif'] <- symnum(stat_table$p_value,
                               cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1),
                               symbols = c("****", "***", "**", "*", "ns"),
                               abbr.colnames = FALSE,
                               na = "")
```

**Statistical Visualization**
```{r, fig.height=3, fig.width=5.5}
stat_plot(stat_table,
          metab_labs,
          "Metabolite and Toxin Concentration Comparisons") -> tox_metab_stat_vis

tox_metab_stat_vis
```

**Putting my Plots Together**
```{r, warning=FALSE, fig.height=7, fig.width=16}
plot_grid(tox_acetic, tox_butanoic,
          tox_propanoic, tox_metab_stat_vis,
          nrow = 2,
          labels = c('a)', 'b)', 'c)', 'd)')) -> metab_tox_plots

metab_tox_plots
```

**Saving my Outputs**
```{r}
## as a pdf
ggsave('metab_tox_comp.pdf',
       plot = metab_tox_plots,
       width = 16,
       height = 7,
       path = '../plots')

## as an rdata object
save(tox_acetic,
     file = '../../figures/tox_metab_acetic.rdata')
save(tox_butanoic,
     file = '../../figures/tox_metab_butanoic.rdata')
save(tox_propanoic,
     file = '../../figures/tox_metab_propanoic.rdata')
save(tox_metab_stat_vis,
     file = '../../figures/tox_metab_stats.rdata')
```

