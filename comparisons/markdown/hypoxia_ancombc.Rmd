---
title: "hypoxia_ancombc"
output: html_document
date: "2023-12-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(qiime2R)
library(cowplot)
library(magrittr)
library(rstatix)
library(vegan)
library(broom)
library(ANCOMBC)
library(microViz)
library(phyloseq)
library(cowplot)
```

**Functions**
```{r}
## ancombc file prep and running it function
run_ancombc <- function(otu_fp,
                        tax_fp,
                        metadata_table,
                        wanted_tax_level,
                        formula,
                        adj_method){
  ## metadata table 
  metadata <- as.data.frame(metadata_table)
  rownames(metadata) <- metadata$sampleid
  ## otu table
  otu_table <- read_qza(otu_fp)$data
  otu_table %>% 
    as_tibble(rownames = 'taxon') %>% 
    gather(-taxon, key = sampleid, value = abun) %>% 
    filter(sampleid %in% metadata$sampleid) %>% 
    spread(sampleid, abun) -> otu_table

  otu_table <- as.data.frame(otu_table)
  rownames(otu_table) <- otu_table$taxon
  proc_otu <- subset(otu_table,
                     select = -taxon)
  metadata %>% 
    filter(metadata$sampleid %in% colnames(proc_otu)) -> metadata
  ## taxonomy table
  tax_table <- read_qza(tax_fp)$data %>% 
    parse_taxonomy()
  tax_table %>% 
    filter(rownames(tax_table) %in% rownames(proc_otu)) -> tax_table
  ## creating phyloseq object
  pseq <- phyloseq::phyloseq(otu_table(proc_otu, taxa_are_rows = TRUE),
                             tax_table(as.matrix(tax_table)),
                             sample_data(metadata))
  # sample_data(pseq)$diet <- as.factor(sample_data(pseq)$diet)
  # sample_data(pseq)$diet <- relevel(sample_data(pseq)$diet, baseline)
  ## running ancombc
  ## everything but data (pseq) can be a string
  ancombc_res <- ancombc2(data = pseq,
                          tax_level = wanted_tax_level,
                          fix_formula = formula,
                          p_adj_method = adj_method)
  ## pulling wanted results out
  results <- ancombc_res$res
  ## creating a list of outputs
  my_list <- list(ANCOMBCResults = results,
                  Metadata = metadata,
                  OTUTable = proc_otu,
                  Taxonomy = tax_table,
                  Pseq = pseq)
  return(my_list)
}

## mini metadata filtering function
meta_diet_filter <- function(metadata_table,
                            diet_filter){
  metadata_table %>% 
    filter(fiber == diet_filter) -> diet_metadata
  return(diet_metadata)
}

## creating a for loop to run ancombc on each day_post_inf and then put all the tables together into one giant table
ancom_diet_for_loop <- function(otu_fp,
                                tax_fp,
                                metadata_table,
                                wanted_tax_level,
                                formula,
                                adj_method,
                                strat_column){
  output <- list()
  for (i in unique(unlist(metadata_table[strat_column]))) {
    new_metadata <- meta_diet_filter(metadata_table,
                                    i)
    ancombc_results <- run_ancombc(otu_fp,
                                    tax_fp,
                                    new_metadata,
                                    wanted_tax_level,
                                    formula,
                                    adj_method)
    tmp_output <- ancombc_results$ANCOMBCResults
    tmp_output[strat_column] <- i
    output <- append(output, list(tmp_output))
  }
  output <- bind_rows(output)
  return(output)
}

## function to put together plots of lfc by day for each diet baseline 
baseline_plot <- function(baseline_table,
                          facet_labs,
                          names_of_labs,
                          title){
  names(facet_labs) <- names_of_labs
  baseline_table %>% 
    ggplot(aes(x = fiber, y = taxon)) +
    geom_tile(aes(fill = lfc), color = 'black') +
    scale_fill_gradient2(low = 'blue', high = 'red', limits = c(-0.006, 0.006)) +
    geom_text(aes(label = lfc), size = 3) +
    theme_bw(base_size = 16) +
    scale_x_discrete(labels = c('High Fiber',
                                'Low Fiber')) +
    facet_grid(~order,
               labeller = labeller(order = facet_labs)) +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          legend.title = element_blank(),
          plot.title = element_text(face = "bold")) +
    ggtitle(title) -> plot
  return(plot)
}
```

**File Paths**
```{r}
metadata_FP <- '../../cecum/data/misc/filt_cecal_processed_metadata.tsv'
hypoxia_FP <- '../../colon/data/misc/pimid_fluor.csv'
otu_table_FP <- '../../cecum/data/cecal_qiime/tax_filt_actual.qza'
tax_FP <- '../../cecum/data/cecal_qiime/taxonomy.qza'

col_names <- c('taxon',
               'fiber',
               'Cecum',
               'Prox_colon',
               'Dist_colon')

strat_value <- 'fiber'

hypoxia_facet_labs <- c('Cecum',
                        'Proximal Colon',
                        'Distal Colon')
hypoxia_names_labs <- c(1,
                        2,
                        3)
```

**Combining Metadata Table with Hypoxia Data**
We don't have hypoxia data for all mice that we have cecal data for (not sure what's going on here). 
Mouse ID 9743 was duplicated in the hypoxia data but the rest of the values were different (i.e. fluorescence). I think the mouse ids are supposed to go 9740, 9741, 9743, 9742 but I will need to ask Keith. I'm temporarily altering the mouse ids to reflect that order (was 9740, 9742, 9743, 9743). 

Mouse ID 9941 was also duplicated with separate values for each. Need to ask about this. Changed the first duplicate to 9939 (now 9939, 9941, 9943... was 9941, 9941, 9943). 
```{r}
## metadata
metadata <- read_tsv(metadata_FP)

## hypoxia 
hypoxia <- read_csv(hypoxia_FP)

hypoxia %>% 
  group_by(mouse_id, diet, fiber, batch) %>% 
  pivot_wider(names_from = location, 
              values_from = fluorescence) -> hypoxia

hypoxia[[1]][[4]] <- '9939'

metadata %>% 
  select(sampleid, mouse_id) %>% 
  mutate(mouse_id = as.character(mouse_id)) %>% 
  left_join(hypoxia, by = 'mouse_id') %>% 
  na.omit() -> metadata
```

**Attempting ANCOMBC**
```{r, warning=FALSE}
test_res <- ancom_diet_for_loop(otu_table_FP,
                                tax_FP,
                                metadata,
                                'Family',
                                'Cecum + Prox_colon + Dist_colon',
                                'BH',
                                strat_value)
```

**Data Wrangling for ANCOMBC Plot**
```{r}
test_res %>% 
  filter(diff_Cecum == TRUE | diff_Dist_colon == TRUE | diff_Prox_colon == TRUE) %>% 
  mutate(lfc_cecum_corr = (lfc_Cecum * diff_Cecum),
         lfc_prox_colon_corr = (lfc_Prox_colon * diff_Prox_colon),
         lfc_dist_colon_corr = (lfc_Dist_colon * diff_Dist_colon)) %>% 
  select(taxon, fiber, contains('corr')) -> test_lfc

colnames(test_lfc) <- col_names

test_lfc %>% 
  gather(-taxon, -fiber, key = location, value = lfc) %>% 
  mutate(lfc = as.numeric(lfc),
         lfc = signif(lfc, digits = 5)) %>% 
  mutate(order = ifelse(location == 'Cecum', 1, location),
         order = ifelse(order == 'Prox_colon', 2, order),
         order = ifelse(order == 'Dist_colon', 3, order)) %>% 
    arrange(order) -> test_lfc
```

**Plot**
I think I want to go through and run the ANCOMBC analysis based on location between diets and then smush them together. Or I can run the analysis between locations for each diet and then smuch it together for a plot. I like my first suggestion better but we'll see. 

Update: I tried to do this by diet but there were too few data points and ANCOMBC got upset with me so that's why it's sectioned out by dietary fiber content instead. In this dataset, chow is coded under high fiber. 
```{r, fig.width=13, fig.height=10}
test_plot <- baseline_plot(test_lfc,
                           hypoxia_facet_labs,
                           hypoxia_names_labs,
                           'Log Fold Change of Oxygen Concentration\nby Location and Dietary Fiber Content')

test_plot
```

**Saving my Output**
```{r}
ggsave('../plots/hypoxia_ancombc.pdf',
       plot = test_plot,
       width = 13, 
       height = 10)
```

