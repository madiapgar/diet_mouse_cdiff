---
title: "histology"
format: html
editor: visual
---

```{r, include=FALSE}
library(broom)
library(cowplot)
library(magrittr)
library(qiime2R)
library(tidyverse)
```

**Basic Functions**

```{r}
## creating a function for this so I don't have to keep doing each one by hand 
stat_plot_prep <- function(biom_table,
                           dunn_test,
                           value){
  biom_table %>% 
    group_by(tissue, diet, facility) %>% 
    summarise(means = mean(.data[[value]])) -> mean_table
  dunn_test %>% 
    merge(mean_table, 
          by.x = c('group1',
                   'diet'),
          by.y = c('tissue',
                   'diet')) %>% 
    rename('group1_means' = 'means') %>% 
    merge(mean_table,
          by.x = c('group2',
                   'diet'),
          by.y = c('tissue',
                   'diet')) %>% 
    rename('group2_means' = 'means') %>% 
    mutate(diff_means = (group1_means - group2_means)) -> new_dunn
           # stat_diff_means = if_else(p.adj > 0.05, 0, diff_means)) -> new_dunn
  return(new_dunn)
}

stat_plot <- function(new_dunn){
  new_dunn %>% 
    ggplot(aes(x = group1, y = group2)) +
    geom_tile(aes(fill = stat_diff_means), alpha = 0.8, color = 'black') +
    scale_fill_gradient2(low = 'blue', high = 'green', name = 'Group 1 -\nGroup 2') +
    geom_text(aes(label = p.adj.signif)) +
    # scale_x_discrete(labels = c('Chow',
    #                             'HFt/\nHFb',
    #                             'HFt/\nLFb',
    #                             'LFt/\nHFb')) +
    # scale_y_discrete(labels = c('HFt / HFb',
    #                             'HFt / LFb',
    #                             'LFt / HFb',
    #                             'LFt / LFb')) +
    facet_grid(tissue~diet,
              scales = 'free_x') +
    theme_bw(base_size = 20) +
    theme(strip.text.y = element_text(angle = 0)) +
    xlab('Group 1') +
    ylab('Group 2') -> stat_vis
  return(stat_vis)
}
```

**File Paths**

```{r}
metadata_FP <- '../data/misc/processed_metadata.tsv'
seq_depth_FP <- '../data/misc/tss_seq_depth.tsv'
histo_FP <- '../data/misc/histo_data.csv'

## lists to redo the diet names on the facet labels of the ggplot created below 
diet_labs <- 
    c('Chow', 
      'High Fat / High Fiber', 
      'High Fat / Low Fiber', 
      'Low Fat / High Fiber', 
      'Low Fat / Low Fiber')

names(diet_labs) <- c('Chow', 'HF/HF', 'HF/LF', 'LF/HF', 'LF/LF')

tissue_labs <- c('Cecum',
                 'Colon')
names(tissue_labs) <- c('cecum',
                        'colon')
```

**Reading in Metadata and Histopathology Files**

the bulk of the histopathology scores are from mice that died before day 3

```{r}
metadata <- read_tsv(metadata_FP)

histo <- read_csv(histo_FP) %>% 
  filter(!is.na(mouse_id))

wanted_ids <- histo$mouse_id

## joining them all together for ggplot rendering 
metadata %>% 
  merge(histo, by = 'mouse_id') %>% 
  group_by(mouse_id) %>% 
  filter(day_post_inf == max(day_post_inf)) %>% 
  ungroup() %>% 
  mutate(day_post_inf = as.factor(day_post_inf)) %>% 
  gather(cecum, colon, key = tissue, value = score) -> big_histo
```

**Histopathology Score Kruskal-Wallis and Dunn's Post Hoc Tests**

All mice and days are included in the below statistical analysis and ggplot.

```{r}
big_histo %>% 
  group_by(tissue, diet) %>% 
  do(tidy(kruskal.test(score ~ facility,
                       data = .))) %>% 
  ungroup() %>%
  arrange(p.value) %>%
  mutate(p.adj = p.adjust(p.value,
                          method = "BH"),
        test_id = paste(tissue, diet, sep = "_")) -> all_day_kruskal

big_histo %>% 
  group_by(tissue, diet) %>% 
  mutate(test_id = paste(tissue, diet, sep = "_")) %>% 
  filter(test_id %in% all_day_kruskal$test_id) %>% 
  dunn_test(score ~ facility,
            p.adjust.method = 'BH',
            data =.) %>% 
  add_y_position(scales = 'free_y', step.increase = 0) -> all_day_dunn

all_day_dunn
```

```{r}
stat_plot_prep(big_histo,
               all_day_dunn,
               "score") -> test_dunn
```

**Running a t test on histopathology score by barrier facility**

```{r}
## this is a t test based on histopathology score of tissue site per diet based on the barrier facility the mice came from 
big_histo %>% 
  group_by(tissue, diet) %>% 
  do(tidy(t.test(score ~ facility,
                 data =.))) %>% 
  mutate(adj.p.value = p.adjust(p.value)) %>% 
  filter(adj.p.value <= 0.05) -> t_test

t_test
```

**Histopathology Plot with Significance Levels**

```{r, fig.height=8, fig.width=10}
big_histo %>% 
  mutate(day_post_inf = as.numeric(day_post_inf)) %>% 
  ggplot(aes(x = diet, y = score)) +
  geom_violin(aes(group = diet),  draw_quantiles = c(0.5)) +
  geom_jitter(alpha = 0.4, width = 0.1, height = 0) +
  scale_x_discrete(labels = c('Chow', 
                              'HFt/\nHFb', 
                              'HFt/\nLFb',
                              'LFt/\nHFb', 
                              'LFt/\nLFb')) +
  facet_grid(tissue~facility, labeller = labeller(tissue = tissue_labs),
             scales = "free_y") +
  # stat_pvalue_manual(all_day_dunn,
  #                    tip.length = 0.01,
  #                    label = 'p.adj.signif',
  #                    hide.ns = TRUE,
  #                    step.increase = 0.1) +
  theme_bw(base_size = 20) +
  theme(strip.text.y = element_text(angle = 0)) +
  xlab('Diet') +
  ylab('Histopathology Score') +
  ggtitle("Histopathology Score by Diet") -> all_day_plot

all_day_plot
```

**Histopathology Score Linear Modeling**\
running a linear model on the histopathology of all mice, regardless of day of death and cecal removal.

```{r}
big_histo %>% 
  group_by(tissue) %>% 
  do(glance(lm(score ~ (purified_diet * seq_depth) + high_fat * high_fiber,
             data =.))) %>% 
  ungroup() %>%
  na.omit() %>%
  mutate(adj.p = p.adjust(p.value,
                          method = "BH"),
        test_id = paste(tissue)) %>% 
  filter(adj.p <= 0.05) -> big_histo_lm_full

big_histo %>% 
  group_by(tissue) %>% 
  mutate(test_id = paste(tissue)) %>% 
  filter(test_id %in% big_histo_lm_full$test_id) %>% 
  do(tidy(lm(score ~ (purified_diet * seq_depth) + high_fat * high_fiber,
             data =.))) %>%
  filter(term != '(Intercept)') %>% 
  na.omit() -> big_histo_lm

big_histo_lm['signif'] <- symnum(big_histo_lm$p.value,
                                 cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
                                 symbols = c("****", "***", "**", "*", "+", "ns"),
                                 abbr.colnames = FALSE,
                                 na = "")
big_histo_lm
```

**Plotting the Cecum and Colon Histopathology Scores**

comparing the histopathology scores between the cecum and colon, can see a positive correlation between the two.

```{r}
histo %>% 
  ggplot(aes(x = colon, y = cecum)) +
    geom_point() +
    geom_smooth(method = 'lm') +
    theme_bw(base_size = 14) -> histo_compare

histo_compare
```

**Linear Modeling for Cecum and Colon Histopathology Scores**

```{r}
histo %>% 
  do(tidy(lm(colon ~ cecum,
            data =.))) %>% 
  adjust_pvalue(method = 'BH')
```

**Saving Plot and Stats**

```{r}
ggsave("histopathology_all.pdf", 
       plot = all_day_plot,
       width = 13, 
       height = 6,
       path = '../plots')
write_tsv(big_histo_lm,
          '../stats/histopathology_all.tsv')
```
