---
title: "micro_abun_correlations"
output: html_document
date: "2023-10-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(qiime2R)
library(cowplot)
library(magrittr)
library(rstatix)
library(vegan)
library(broom)
```

**Functions**
```{r}
## abundance file prep and filtering function
## combines all files into one large table
abun_file_prep <- function(metadata_fp,
                                  tax_fp,
                                  otu_table_fp,
                                  histo_fp,
                                  tax_level,
                                  wanted_tax){
  ## metadata
  metadata <- read_tsv(metadata_fp)
  ## histopathology scores
  histo <- read_csv(histo_fp)
  ## taxonomy
  taxonomy <- read_qza(tax_fp)$data %>% 
  parse_taxonomy() %>% 
  rownames_to_column('asv')
  ## otu table 
  otu_table <- read_qza(otu_table_fp)$data
  otu_table %>% 
    as_tibble(rownames = 'asv') %>% 
    gather(-asv, key = sampleid, value = abun) %>% 
    group_by(sampleid) %>% 
    mutate(rel_abun = abun/sum(abun)) %>% 
    mutate(rel_abun = rel_abun + 0.000001) -> otu_table
  ## joining all tables together 
  otu_table %>% 
    left_join(metadata, by = 'sampleid') %>% 
    left_join(taxonomy, by = 'asv') %>% 
    merge(histo, by = 'mouse_id') %>% 
    group_by(mouse_id) %>% 
    filter(day_post_inf == max(day_post_inf)) %>% 
    ungroup() %>% 
    gather(cecum, colon, key = tissue, value = score) -> abun_table
  
  abun_table %>% 
    group_by(sampleid, day_post_inf, diet, mouse_id, 
             purified_diet, high_fat, high_fiber, 
             seq_depth, .data[[tax_level]], asv, tissue, score) %>% 
    summarise(rel_abund = sum(rel_abun)) %>% 
    filter(.data[[tax_level]] %in% wanted_tax) %>% 
    mutate(mouse_fact = as.factor(mouse_id),
           day_fact = as.factor(day_post_inf)) -> abun_filt
  ## creating a list for my outputs
  my_list <- list(Metadata = metadata,
                  Taxonomy = taxonomy,
                  OTUTable = otu_table,
                  Histo = histo,
                  AbundanceTable = abun_filt)
  return(my_list)
}
```

**Input File Paths**
```{r}
otu_table_FP <- '../data/qiime/taxonomy_filtered.qza'
tax_FP <- '../data/qiime/taxonomy.qza'
metadata_FP <- '../data/misc/processed_metadata.tsv'
histo_FP <- '../data/misc/histo_data.csv'

wanted_family <- c('Enterobacteriaceae', 
                         'Enterococcaceae', 
                         'Staphylococcaceae',
                         'Lachnospiraceae',
                         'Ruminococcaceae',
                         'Bacteroidaceae',
                         'Marinifilaceae',
                         'Peptostreptococcaceae')
wanted_level <- 'Family'
```

**Processing my Files into One Giant Table**
```{r}
abun_files <- abun_file_prep(metadata_FP,
                             tax_FP,
                             otu_table_FP,
                             histo_FP,
                             wanted_level,
                             wanted_family)

abun_filt <- abun_files$AbundanceTable
tax <- abun_files$Taxonomy
otu <- abun_files$OTUTable
```

```{r}
abun_filt %>% 
  na.omit() %>% 
  group_by(diet, tissue, Family) %>% 
  do(glance(lm(score ~ rel_abund,
             data = .)))
  # mutate(adj.p = p.adjust(p.value,
  #                         method = 'BH')) %>% 
  # filter(p.value <= 0.05,
  #        term != '(Intercept)')
```

