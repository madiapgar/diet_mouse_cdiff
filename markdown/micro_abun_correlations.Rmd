---
title: "micro_abun_correlations"
output: html_document
date: "2023-10-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(qiime2R)
library(cowplot)
library(magrittr)
library(rstatix)
library(vegan)
library(broom)
library(ANCOMBC)
library(microViz)
```

**Functions**
```{r}
## abundance file prep and filtering function
## combines all files into one large table
abun_file_prep <- function(metadata_fp,
                                  tax_fp,
                                  otu_table_fp,
                                  histo_fp,
                                  tax_level,
                                  wanted_tax){
  ## metadata
  metadata <- read_tsv(metadata_fp)
  ## histopathology scores
  histo <- read_csv(histo_fp)
  ## taxonomy
  taxonomy <- read_qza(tax_fp)$data %>% 
  parse_taxonomy() %>% 
  rownames_to_column('asv')
  ## otu table 
  otu_table <- read_qza(otu_table_fp)$data
  otu_table %>% 
    as_tibble(rownames = 'asv') %>% 
    gather(-asv, key = sampleid, value = abun) %>% 
    group_by(sampleid) %>% 
    mutate(rel_abun = abun/sum(abun)) %>% 
    mutate(rel_abun = rel_abun + 0.000001) -> otu_table
  ## joining all tables together 
  otu_table %>% 
    left_join(metadata, by = 'sampleid') %>% 
    left_join(taxonomy, by = 'asv') %>% 
    merge(histo, by = 'mouse_id') %>% 
    group_by(mouse_id) %>% 
    filter(day_post_inf == max(day_post_inf)) %>% 
    ungroup() %>% 
    gather(cecum, colon, key = tissue, value = score) -> abun_table
  
  abun_table %>% 
    group_by(sampleid, day_post_inf, diet, mouse_id, 
             purified_diet, high_fat, high_fiber, 
             seq_depth, .data[[tax_level]], asv, tissue, score) %>% 
    summarise(rel_abund = sum(rel_abun)) %>% 
    filter(.data[[tax_level]] %in% wanted_tax) %>% 
    mutate(mouse_fact = as.factor(mouse_id),
           day_fact = as.factor(day_post_inf)) -> abun_filt
  ## creating a list for my outputs
  my_list <- list(Metadata = metadata,
                  Taxonomy = taxonomy,
                  OTUTable = otu_table,
                  Histo = histo,
                  AbundanceTable = abun_filt)
  return(my_list)
}
```

**Input File Paths**
```{r}
otu_table_FP <- '../data/qiime/tax_filt_actual.qza'
tax_FP <- '../data/qiime/taxonomy.qza'
metadata_FP <- '../data/misc/processed_metadata.tsv'
histo_FP <- '../data/misc/histo_data.csv'
tmp_meta_fp <- '../data/misc/updated_metadata.tsv'

histo_otu_fp <- '../data/qiime/histo_tax_filt.qza'
histo_meta_fp <- '../data/misc/histo_updated_metadata.tsv'

## diet only file paths
ancombc_pVal_fp <- '../data/qiime/ancombc_diet_only/p_val_slice.csv'
ancombc_qVal_fp <- '../data/qiime/ancombc_diet_only/q_val_slice.csv'
ancombc_wSlice_fp <- '../data/qiime/ancombc_diet_only/w_slice.csv'
ancombc_seSlice_fp <- '../data/qiime/ancombc_diet_only/se_slice.csv'
ancombc_lfcSlice_fp <- '../data/qiime/ancombc_diet_only/lfc_slice.csv'

wanted_family <- c('Enterobacteriaceae', 
                         'Enterococcaceae', 
                         'Staphylococcaceae',
                         'Lachnospiraceae',
                         'Ruminococcaceae',
                         'Bacteroidaceae',
                         'Marinifilaceae',
                         'Peptostreptococcaceae')
wanted_level <- 'Family'
```

**Processing my Files into One Giant Table**
```{r}
abun_files <- abun_file_prep(metadata_FP,
                             tax_FP,
                             otu_table_FP,
                             histo_FP,
                             wanted_level,
                             wanted_family)

abun_filt <- abun_files$AbundanceTable
tax <- abun_files$Taxonomy
otu <- abun_files$OTUTable
```

```{r}
abun_filt %>% 
  na.omit() %>% 
  group_by(diet, tissue, Family) %>% 
  do(tidy(lm(score ~ rel_abund,
             data = .))) %>% 
  mutate(adj.p = p.adjust(p.value,
                          method = 'BH')) %>%
  filter(p.value <= 0.05,
         term != '(Intercept)')
```
## **ANCOMBC results for ASV by Diet Only - These were Run in Qiime2**
**Reading in ANCOMBC results for ASV by Diet**
these are all calculated relative to chow as the baseline diet (I'm not sure how to turn the reference level off)
```{r}
new_col_names <- c('asv',
                   'intercept',
                   'HF/HF',
                   'HF/LF',
                   'LF/HF',
                   'LF/LF')
## p-values
p_val <- read_csv(ancombc_pVal_fp,
                  skip = 1,
                  col_names = new_col_names)

## adjusted p-values
q_val <- read_csv(ancombc_qVal_fp,
                  skip = 1,
                  col_names = new_col_names)

## test statistic
w_slice <- read_csv(ancombc_wSlice_fp,
                    skip = 1,
                    col_names = new_col_names)

## standard errors
se_slice <- read_csv(ancombc_seSlice_fp,
                     skip = 1,
                     col_names = new_col_names)

## log fold changes
lfc <- read_csv(ancombc_lfcSlice_fp,
                skip = 1,
                col_names = new_col_names)
```
**Log-fold-change Visualization**
```{r, fig.width=20, fig.height=8}
## putting log fold change data with taxonomic information
lfc %>% 
  select(-intercept) %>% 
  gather(-asv, key = diet, value = lfc) %>% 
  inner_join(tax, by = 'asv') -> lfc_w_tax

lfc_w_tax %>% 
  filter(Family %in% wanted_family) %>% 
  ggplot(aes(x = asv, y = Family)) +
  geom_tile(aes(fill = lfc), color = 'black') +
  scale_fill_gradient2(low = 'blue', high = 'red', name = 'Log Fold Change') +
  # geom_text(aes(label = lfc)) +
  facet_wrap(~diet) +
  theme_bw() +
  theme(axis.text.x = element_blank()) +
  xlab('ASV') -> lfc_tax_plot

lfc_tax_plot
```

## **ANCOMBC results for ASV by Histo Score - These were Run in R**
**Creating a pseq object for ANCOMBC and running it**
```{r}
histo_pseq <- qiime2R::qza_to_phyloseq(features = histo_otu_fp,
                                       taxonomy = tax_FP,
                                       metadata = histo_meta_fp)
```

```{r}
histo_ancom <- ancombc2(data = histo_pseq,
                        tax_level = 'Family',
                        fix_formula = 'cecum + colon',
                        p_adj_method = 'BH')
```

**Getting results out**
```{r}
histo_res <- histo_ancom$res
```

**Log-fold-change Visualization**
```{r}
histo_col_names <- c('taxon',
                   'intercept',
                   'cecum',
                   'colon')
histo_res %>% 
  select(taxon, contains('lfc')) -> histo_lfc
colnames(histo_lfc) <- histo_col_names

histo_lfc %>% 
  gather(!c(taxon, intercept), key = tissue, value = lfc) %>% 
  mutate(lfc = round(lfc, 2))-> histo_lfc
```

```{r, fig.width=10, fig.height=10}
histo_lfc %>% 
  ggplot(aes(x = tissue, y = taxon)) +
  geom_tile(aes(fill = lfc), color = 'black') +
  scale_fill_gradient2(low = 'blue', high = 'red', name = 'log fold\nchanges') +
  geom_text(aes(label = lfc), size = 3) +
  theme_bw() -> histo_lfc_plot

histo_lfc_plot
```

## **ANCOMBC results for ASV by Diet - These were Run in R**
**Creating a pseq object**
```{r}
diet_pseq <- qiime2R::qza_to_phyloseq(features = otu_table_FP,
                                      taxonomy = tax_FP,
                                      metadata = tmp_meta_fp)
```

**Running ANCOMBC**
```{r}
diet_ancom <- ancombc2(data = diet_pseq,
                       tax_level = 'Family',
                       fix_formula = 'diet',
                       p_adj_method = 'BH')

diet_res <- diet_ancom$res
```

**File prep for Log Fold Change plot**
```{r}
## how I've been doing it
diet_col_names <- c('taxon',
                    'intercept',
                    'HF/HF',
                    'HF/LF',
                    'LF/HF',
                    'LF/LF')
diet_res %>% 
  select(taxon, contains('lfc')) -> diet_lfc
colnames(diet_lfc) <- diet_col_names

diet_lfc %>% 
  gather(!c(taxon, intercept), key = diet, value = lfc) %>% 
  mutate(lfc = round(lfc, 2)) -> diet_lfc
```

**The plot!!**
```{r, fig.width=10, fig.height=10}
diet_lfc %>% 
  ggplot(aes(x = diet, y = taxon)) +
  geom_tile(aes(fill = lfc), color = 'black') +
  scale_fill_gradient2(low = 'blue', high = 'red') +
  geom_text(aes(label = lfc), size = 3) +
  theme_bw() +
  scale_x_discrete(labels = c('HFt/HFb',
                              'HFt/LFb',
                              'LFt/HFb',
                              'LFt/LFb')) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  ggtitle('Log Fold Changes Compared to Mice on the Chow Diet') -> diet_lfc_plot

diet_lfc_plot
```

## **ANCOMBC results for ASV by Dietary Content - These were Run in R**
**Prepping phyloseq object**
```{r}
ft_fb_pseq <- qiime2R::qza_to_phyloseq(features = otu_table_FP,
                                       taxonomy = tax_FP,
                                       metadata = metadata_FP)
```

**Running ANCOMBC**
```{r}
ft_fb_res <- ancombc2(data = ft_fb_pseq,
                      tax_level = 'Family',
                      fix_formula = 'high_fat + high_fiber + purified_diet',
                      p_adj_method = 'BH')
ft_fb_actualRes <- ft_fb_res$res
```

**File prep for Log Fold Change plot**
```{r}
ftFb_col_names <- c('taxon',
                    'intercept',
                    'high_fat',
                    'high_fiber',
                    'purified_diet')
ft_fb_actualRes %>% 
  select(taxon, contains('lfc')) -> ft_fb_lfc
colnames(ft_fb_lfc) <- ftFb_col_names

ft_fb_lfc %>% 
  gather(!c(taxon, intercept), key = component, value = lfc) %>% 
  mutate(lfc = round(lfc, 2)) -> ft_fb_lfc
```

**another plot**
```{r, fig.width=10, fig.height=10}
ft_fb_lfc %>% 
  ggplot(aes(x = component, y = taxon)) +
  geom_tile(aes(fill = lfc), color = 'black') +
  scale_fill_gradient2(low = 'blue', high = 'red') +
  geom_text(aes(label = lfc), size = 3) +
  theme_bw() +
  scale_x_discrete(labels = c('High Fat',
                              'High Fiber',
                              'Purified Diet')) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  ggtitle('Log Fold Changes by Diet Composition') -> ftFb_lfc_plot

ftFb_lfc_plot
```

## **ANCOMBC results for ASV by Diet and Histo Score - These were Run in R**
**Prepping phyloseq object**
```{r}
histo_diet_pseq <- qiime2R::qza_to_phyloseq(features = histo_otu_fp,
                                             taxonomy = tax_FP,
                                             metadata = histo_meta_fp)
```

**Running ANCOMBC - pairwise between diets?**
```{r}
histo_diet_ancom <- ancombc2(data = histo_diet_pseq,
                             tax_level = 'Family',
                             fix_formula = 'diet + cecum + colon',
                             group = 'diet',
                             pairwise = TRUE,
                             p_adj_method = 'BH')
histo_diet_res <- histo_diet_ancom$res
```


**Saving my Outputs**
```{r}
ggsave('diet_lfc.pdf',
       plot = diet_lfc_plot,
       width = 10, 
       height = 10, 
       path = '../plots')
ggsave('diet_comp_lfc.pdf',
       plot = ftFb_lfc_plot,
       width = 10, 
       height = 10, 
       path = '../plots')
```

