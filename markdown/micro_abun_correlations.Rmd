---
title: "micro_abun_correlations"
output: html_document
date: "2023-10-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(qiime2R)
library(cowplot)
library(magrittr)
library(rstatix)
library(vegan)
library(broom)
library(ANCOMBC)
library(microViz)
library(phyloseq)
```

**Functions**
```{r}
## ancombc file prep and running it function
run_ancombc <- function(otu_fp,
                        tax_fp,
                        metadata_table,
                        wanted_tax_level,
                        formula,
                        adj_method){
  ## metadata table 
  metadata <- as.data.frame(metadata_table)
  rownames(metadata) <- metadata$sampleid
  ## otu table
  otu_table <- read_qza(otu_fp)$data
  otu_table %>% 
    as_tibble(rownames = 'taxon') %>% 
    gather(-taxon, key = sampleid, value = abun) %>% 
    filter(sampleid %in% metadata$sampleid) %>% 
    spread(sampleid, abun) -> otu_table

  otu_table <- as.data.frame(otu_table)
  rownames(otu_table) <- otu_table$taxon
  proc_otu <- subset(otu_table,
                     select = -taxon)
  metadata %>% 
    filter(metadata$sampleid %in% colnames(proc_otu)) -> metadata
  ## taxonomy table
  tax_table <- read_qza(tax_fp)$data %>% 
    parse_taxonomy()
  tax_table %>% 
    filter(rownames(tax_table) %in% rownames(proc_otu)) -> tax_table
  ## creating phyloseq object
  pseq <- phyloseq::phyloseq(otu_table(proc_otu, taxa_are_rows = TRUE),
                             tax_table(as.matrix(tax_table)),
                             sample_data(metadata))
  ## running ancombc
  ## everything but data (pseq) can be a string
  ancombc_res <- ancombc2(data = pseq,
                          tax_level = wanted_tax_level,
                          fix_formula = formula,
                          p_adj_method = adj_method)
                          # group = "diet",
                          # pairwise = TRUE,
                          # dunnet = TRUE)
  ## pulling wanted results out
  results <- ancombc_res$res
  ## creating a list of outputs
  my_list <- list(ANCOMBCResults = results,
                  Metadata = metadata,
                  OTUTable = proc_otu,
                  Taxonomy = tax_table)
  return(my_list)
}

## mini metadata filtering function
meta_day_filter <- function(metadata_table,
                            day_filter){
  metadata_table %>% 
    filter(day_post_inf == day_filter) -> day_metadata
  return(day_metadata)
}

## creating a for loop to run ancombc on each day_post_inf and then put all the tables together into one giant table
ancom_day_for_loop <- function(otu_fp,
                                tax_fp,
                                metadata_table,
                                wanted_tax_level,
                                formula,
                                adj_method,
                                strat_column){
  output <- list()
  for (i in unique(unlist(metadata_table[strat_column]))) {
    new_metadata <- meta_day_filter(metadata_table,
                                    i)
    ancombc_results <- run_ancombc(otu_fp,
                                    tax_fp,
                                    new_metadata,
                                    wanted_tax_level,
                                    formula,
                                    adj_method)
    tmp_output <- ancombc_results$ANCOMBCResults
    tmp_output[strat_column] <- i
    output <- append(output, list(tmp_output))
  }
  output <- bind_rows(output)
  return(output)
}
```

**Input File Paths**
```{r}
otu_table_FP <- '../data/qiime/tax_filt_actual.qza'
tax_FP <- '../data/qiime/taxonomy.qza'
metadata_FP <- '../data/misc/processed_metadata.tsv'

ftFb_col_names <- c('taxon',
                    'high_fat',
                    'high_fiber',
                    'purified_diet')

diet_col_names <- c('taxon',
                    'HF/HF',
                    'HF/LF',
                    'LF/HF',
                    'LF/LF')

day_strat <- 'day_post_inf'

day_col_names <- c('taxon',
                   'day_post_inf',
                    'HF/HF',
                    'HF/LF',
                    'LF/HF',
                    'LF/LF')
```

**Reading in Metadata File**
```{r}
metadata <- read_tsv(metadata_FP)
```

## **ANCOMBC results for ASV by Diet - These were Run in R**

**Running ANCOMBC for Each Individual Day by Diet**
```{r}
test_day_filt <- ancom_day_for_loop(otu_table_FP,
                                     tax_FP,
                                     metadata,
                                     'Family',
                                     'diet',
                                     'BH',
                                     day_strat)
```

**Wrangling my LFC Results and Pulling out Significant Ones**
```{r}
test_day_filt %>% 
  filter(`diff_dietHF/HF` == TRUE | `diff_dietHF/LF` == TRUE | `diff_dietLF/HF` == TRUE | `diff_dietLF/LF` == TRUE) %>% 
  mutate(lfc_hftHfb_corr = (`lfc_dietHF/HF` * `diff_dietHF/HF`),
         lfc_hftLfb_corr = (`lfc_dietHF/LF` * `diff_dietHF/LF`),
         lfc_lftHfb_corr = (`lfc_dietLF/HF` * `diff_dietLF/HF`),
         lfc_lftLfb_corr = (`lfc_dietLF/LF` * `diff_dietLF/LF`)) %>% 
  select(taxon, day_post_inf, contains('corr')) -> test_day_lfc

colnames(test_day_lfc) <- day_col_names

test_day_lfc %>%
  gather(!c(taxon, day_post_inf), key = diet, value = lfc) %>% 
  mutate(lfc = round(lfc, 2)) -> day_lfc
```

**LFC Plot by Diet and Day Relative to Infection**
```{r, fig.width=12, fig.height=6}
day_lfc %>% 
  ggplot(aes(x = diet, y = taxon)) +
  geom_tile(aes(fill = lfc), color = 'black') +
  scale_fill_gradient2(low = 'blue', high = 'red') +
  geom_text(aes(label = lfc), size = 3) +
  theme_bw() +
  scale_x_discrete(labels = c('HFt/\nHFb',
                              'HFt/\nLFb',
                              'LFt/\nHFb',
                              'LFt/\nLFb')) +
  facet_wrap(~day_post_inf,
             nrow = 1) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  ggtitle('Log Fold Changes Compared to Mice on the Chow Diet')
```

## **ANCOMBC results for ASV by Dietary Content - These were Run in R**

**Running ANCOMBC**
```{r}
ft_fb_res <- run_ancombc(otu_table_FP,
                                   tax_FP,
                                   metadata,
                                   'Family',
                                   'high_fat + high_fiber + purified_diet',
                                   'BH')

ft_fb_actualRes <- ft_fb_res$ANCOMBCResults
```

**File prep for Log Fold Change plot**
```{r}
ft_fb_actualRes %>% 
  filter(diff_high_fat == TRUE | diff_high_fiber == TRUE | diff_purified_diet == TRUE) %>% 
  mutate(lfc_high_fat_corr = (lfc_high_fat * diff_high_fat),
         lfc_high_fiber_corr = (lfc_high_fiber * diff_high_fiber),
         lfc_purified_diet_corr = (lfc_purified_diet * diff_purified_diet)) %>% 
  select(taxon, contains('corr')) -> ft_fb_lfc

colnames(ft_fb_lfc) <- ftFb_col_names

ft_fb_lfc %>% 
  gather(!c(taxon), key = component, value = lfc) %>% 
  mutate(lfc = round(lfc, 2)) -> ft_fb_lfc
```

**Log Fold Change Plot!**
- go in and change zeros to 'ns' so that's more clear 
- interaction term manually: combine the purified column to the other column you want to see the interaction with (paste two binary terms with a sep as "_")
 - high fat pasted with purified diet
 - high fiber pasted with purified diet
 - include regular diet column 
 - put these in the formula
- ancombc formula 
  -pairwise = TRUE
  -dunnet = TRUE
  -group = "diet"
- run this on subsetted data by days relative to infection instead of the previous plot 
```{r, fig.width=6.5, fig.height=9.5}
ft_fb_lfc %>% 
  ggplot(aes(x = component, y = taxon)) +
  geom_tile(aes(fill = lfc), color = 'black') +
  scale_fill_gradient2(low = 'blue', high = 'red') +
  geom_text(aes(label = lfc), size = 3) +
  theme_bw() +
  scale_x_discrete(labels = c('High Fat',
                              'High Fiber',
                              'Purified Diet')) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  ggtitle('Log Fold Changes by Diet Composition') -> ftFb_lfc_plot

ftFb_lfc_plot
```

**Saving my Outputs**
```{r}
ggsave('diet_lfc.pdf',
       plot = diet_lfc_plot,
       width = 6, 
       height = 6, 
       path = '../plots')
ggsave('diet_comp_lfc.pdf',
       plot = ftFb_lfc_plot,
       width = 6.5, 
       height = 9.5, 
       path = '../plots')
```

