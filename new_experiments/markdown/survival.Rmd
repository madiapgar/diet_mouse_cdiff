---
title: "survival"
output: html_document
date: "2024-07-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(survminer)
require(survival)
library(readr)
library(magrittr)
library(viridis)
```

**Functions**
FOR FIT_SURVIVAL:
- column names don't need to be passed in as a string because I'm using *substitute* in the function 
- *substitute* is literally the only way I can pass variables in a function to *Surv()* bc it hates me 
- I use *eval.parent()* instead of *return()* in this function because I'm creating an unevaluated expression with *substitute()*. *eval.parent()* evaluates the expression I create in the function (so in this case, the survival curve fit) and returns it to me. 
```{r}
fit_survival <- function(survival_table,
                         survival_day_col,
                         survival_results_col,
                         test_between_col1,
                         test_between_col2){
  
  params <- list(survival_table = substitute(survival_table),
                 survival_day_col = substitute(survival_day_col),
                 survival_results_col = substitute(survival_results_col),
                 test_between_col1 = substitute(test_between_col1),
                 test_between_col2 = substitute(test_between_col2))
  
  wanted_fit <- substitute(surv_fit(formula = Surv(survival_day_col, survival_results_col) ~ test_between_col1 +
                                      test_between_col2,
                          data = survival_table), params)
  eval.parent(wanted_fit)
}

```

**File Paths**
```{r}
unproc_surv_fp <- '../data/misc/unproc_survival_data.tsv'

diet_labels <- c('Chow',
                 'High Fat / High Fiber', 
                 'High Fat / Low Fiber',
                 'Low Fat / High Fiber',
                 'Low Fat / Low Fiber')
names(diet_labels) <- c('Chow',
                        'HF/HF',
                        'HF/LF',
                        'LF/HF',
                        'LF/LF')

vendor_labels <- c('Charles River',
                   'Taconic')
names(vendor_labels) <- c('charles_river',
                          'taconic')
```

**Reading in File**
```{r}
unproc_surv_table <- read_tsv(unproc_surv_fp,
                              col_types = cols(vendor = col_character(),
                                                mouse_id = col_character(),
                                                experiment = col_character(),
                                                mouse_sex = col_character(),
                                                diet = col_character(),
                                                sac_exptDay = col_integer(),
                                                day_post_inf = col_integer(),
                                                survival = col_integer()))
```

**Ugh data wrangling again**
```{r}
unproc_surv_table <- unproc_surv_table %>% 
                        mutate(test_surv = ifelse(day_post_inf == 14, 0, survival)) %>% 
                        filter(experiment != 'CDD01')
```

**Diet and Vendor Survival Curve**
```{r, fig.width=17, fig.height=7}
## fitting data
diet_surv_fit <- fit_survival(survival_table = unproc_surv_table,
                              survival_day_col = day_post_inf,
                              survival_results_col = test_surv,
                              test_between_col1 = diet,
                              test_between_col2 = vendor)

## plot
diet_base_plot <- ggsurvplot(diet_surv_fit,
                             data = unproc_surv_table,
                             color = "black",
                             ggtheme = theme_bw(base_size = 20),
                             legend = "none",
                             conf.int = TRUE,
                             xlab = 'Days Post Infection',
                             ylab = 'Survival Probability',
                             title = 'Survival by Diet and Vendor')

diet_base_plot$plot +
    facet_grid(cols = vars(diet),
               rows = vars(vendor),
               labeller = labeller(.cols = diet_labels,
                                   .rows = vendor_labels)) +
  theme(strip.text.y.right = element_text(angle = 0)) -> diet_plot_final

diet_plot_final
```

**Experiment and Vendor Survial Curve**
```{r, fig.width=10, fig.height=6}
## fitting data
experiment_surv_fit <- fit_survival(survival_table = unproc_surv_table,
                                    survival_day_col = day_post_inf,
                                    survival_results_col = test_surv,
                                    test_between_col1 = experiment,
                                    test_between_col2 = vendor)

## plot
experiment_base_plot <- ggsurvplot(experiment_surv_fit,
                                   data = unproc_surv_table,
                                   color = "black",
                                   ggtheme = theme_bw(base_size = 20),
                                   legend = "none",
                                   conf.int = TRUE,
                                   xlab = 'Days Post Infection',
                                   ylab = 'Survival Probability',
                                   title = 'Survival by Experiment and Vendor')

experiment_base_plot$plot +
    facet_grid(cols = vars(experiment),
               rows = vars(vendor),
               labeller = labeller(.rows = vendor_labels)) +
    theme(strip.text.y.right = element_text(angle = 0)) -> experiment_plot_final

experiment_plot_final
```

**Stats**
```{r}
## diet
diet_pairwise <- pairwise_survdiff(formula = Surv(day_post_inf, test_surv) ~ diet + vendor,
                                   data = unproc_surv_table,
                                   p.adjust.method = "BH")

diet_pvalue <- as_tibble(diet_pairwise$p.value,
                         rownames = 'diet')
diet_pvalue %>% 
  gather(-diet, key = diet2, value = p.value) %>% 
  na.omit() -> diet_pvalue

names(diet_pvalue)[names(diet_pvalue) == 'diet'] <- 'diet1'


diet_pvalue['signif'] <- symnum(diet_pvalue$p.value,
                                cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
                                symbols = c("****", "***", "**", "*", "+", "ns"),
                                abbr.colnames = FALSE,
                                na = "")
```

```{r}
## experiment
experiment_pairwise <- pairwise_survdiff(formula = Surv(day_post_inf, test_surv) ~ experiment + vendor,
                                         data = unproc_surv_table,
                                         p.adjust.method = "BH")

experiment_pvalue <- as_tibble(experiment_pairwise$p.value,
                         rownames = 'experiment')
experiment_pvalue %>% 
  gather(-experiment, key = experiment2, value = p.value) %>% 
  na.omit() -> experiment_pvalue

names(experiment_pvalue)[names(experiment_pvalue) == 'experiment'] <- 'experiment1'

experiment_pvalue['signif'] <- symnum(experiment_pvalue$p.value,
                                      cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
                                      symbols = c("****", "***", "**", "*", "+", "ns"),
                                      abbr.colnames = FALSE,
                                      na = "")
```

**Saving my Outputs**
```{r}
ggsave('../plots/dietVendor_survival.pdf',
       plot = diet_plot_final,
       width = 17,
       height = 7)
ggsave('../plots/experimentVendor_survival.pdf',
       plot = experiment_plot_final,
       width = 10,
       height = 6)
```

