---
title: "survival"
output: html_document
date: "2024-07-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(survminer)
require(survival)
library(readr)
library(magrittr)
library(viridis)
library(apppleplots)
```

**Functions**
FOR FIT_SURVIVAL:
- column names don't need to be passed in as a string because I'm using *substitute* in the function 
- *substitute* is literally the only way I can pass variables in a function to *Surv()* bc it hates me 
- I use *eval.parent()* instead of *return()* in this function because I'm creating an unevaluated expression with *substitute()*. *eval.parent()* evaluates the expression I create in the function (so in this case, the survival curve fit) and returns it to me. 
```{r}
fit_survival <- function(survival_table,
                         survival_day_col,
                         survival_results_col,
                         test_between_col1,
                         test_between_col2){
  
  params <- list(survival_table = substitute(survival_table),
                 survival_day_col = substitute(survival_day_col),
                 survival_results_col = substitute(survival_results_col),
                 test_between_col1 = substitute(test_between_col1),
                 test_between_col2 = substitute(test_between_col2))
  
  wanted_fit <- substitute(surv_fit(formula = Surv(survival_day_col, survival_results_col) ~ test_between_col1 +
                                      test_between_col2,
                          data = survival_table), params)
  eval.parent(wanted_fit)
}

## to take p-values calculated and put them into a nice table
pretty_pvalue <- function(pairwise_results){
  
  pvalue_table <- as_tibble(pairwise_results$p.value,
                            rownames = 'group1')
  pvalue_table %>% 
    gather(-group1, key = group2, value = p.value) %>% 
    na.omit() -> pvalue_table
  
  pvalue_table['signif'] <- symnum(pvalue_table$p.value,
                                   cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1),
                                   symbols = c("****", "***", "**", "*", "ns"),
                                   abbr.colnames = FALSE,
                                   na = "")
  return(pvalue_table)
}
```

**File Paths**
```{r}
surv_fp <- '../data/misc/survival_data.tsv'

diet_labels <- c('Chow',
                 'High Fat / High Fiber', 
                 'High Fat / Low Fiber',
                 'Low Fat / High Fiber',
                 'Low Fat / Low Fiber')
names(diet_labels) <- c('Chow',
                        'HF/HF',
                        'HF/LF',
                        'LF/HF',
                        'LF/LF')

vendor_labels <- c('Charles River',
                   'Taconic')
names(vendor_labels) <- c('charles_river',
                          'taconic')
```

**Reading in File**
```{r}
surv_table <- read_tsv(surv_fp,
                       col_types = cols(vendor = col_character(),
                                        mouse_id = col_character(),
                                        experiment = col_character(),
                                        mouse_sex = col_character(),
                                        diet = col_character(),
                                        sac_exptDay = col_integer(),
                                        day_post_inf = col_integer(),
                                        survival = col_integer()))

## filtering out the first set of experiments since it could skew the results
surv_table <- surv_table %>% 
                filter(experiment != 'CDD01')
```


**IN THESE PLOTS:**
- Day 0 on the x-axis is the day that the mice are infected with C. diff, so the day that the mice start dying is how soon after CDI that they succumb

**Diet and Vendor Survival Curve**
```{r, fig.width=17, fig.height=7}
## fitting data
dietVendor_surv_fit <- fit_survival(survival_table = surv_table,
                                    survival_day_col = day_post_inf,
                                    survival_results_col = actual_surv,
                                    test_between_col1 = diet,
                                    test_between_col2 = vendor)

## plot
dietVendor_base_plot <- ggsurvplot(dietVendor_surv_fit,
                                   data = surv_table,
                                   color = "black",
                                   ggtheme = theme_bw(base_size = 20),
                                   legend = "none",
                                   conf.int = TRUE,
                                   xlab = 'Days Post Infection',
                                   ylab = 'Survival Probability',
                                   title = 'Mouse Survival After Infection by Diet and Vendor',
                                   subtitle = 'New Experiments')

dietVendor_base_plot$plot +
    facet_grid(cols = vars(diet),
               rows = vars(vendor),
               labeller = labeller(.cols = diet_labels,
                                   .rows = vendor_labels)) +
  theme(strip.text.y.right = element_text(angle = 0)) -> dietVendor_plot

dietVendor_plot
```

**Diet and Experiment Survival Curve**
```{r, fig.width=17, fig.height=7}
## fitting data
dietExp_surv_fit <- fit_survival(survival_table = surv_table,
                                 survival_day_col = day_post_inf,
                                 survival_results_col = actual_surv,
                                 test_between_col1 = diet,
                                 test_between_col2 = experiment)

## plot
dietExp_base_plot <- ggsurvplot(dietExp_surv_fit,
                                data = surv_table,
                                color = "black",
                                ggtheme = theme_bw(base_size = 20),
                                legend = "none",
                                conf.int = TRUE,
                                xlab = 'Days Post Infection',
                                ylab = 'Survival Probability',
                                title = 'Survival by Diet and Experiment')

dietExp_base_plot$plot +
    facet_grid(cols = vars(diet),
               rows = vars(experiment),
               labeller = labeller(.cols = diet_labels)) +
  theme(strip.text.y.right = element_text(angle = 0)) -> dietExp_plot

dietExp_plot
```

**Experiment and Vendor Survial Curve**
```{r, fig.width=10, fig.height=6}
## fitting data
expVendor_surv_fit <- fit_survival(survival_table = surv_table,
                                   survival_day_col = day_post_inf,
                                   survival_results_col = actual_surv,
                                   test_between_col1 = experiment,
                                   test_between_col2 = vendor)

## plot
expVendor_base_plot <- ggsurvplot(expVendor_surv_fit,
                                  data = surv_table,
                                  color = "black",
                                  ggtheme = theme_bw(base_size = 20),
                                  legend = "none",
                                  conf.int = TRUE,
                                  xlab = 'Days Post Infection',
                                  ylab = 'Survival Probability',
                                  title = 'Survival by Experiment and Vendor')

expVendor_base_plot$plot +
    facet_grid(cols = vars(experiment),
               rows = vars(vendor),
               labeller = labeller(.rows = vendor_labels)) +
    theme(strip.text.y.right = element_text(angle = 0)) -> expVendor_plot

expVendor_plot
```

**Stats**
```{r}
## diet and vendor stats
dietVendor_pairwise <- pairwise_survdiff(formula = Surv(day_post_inf, actual_surv) ~ diet + vendor,
                                         data = surv_table,
                                         p.adjust.method = "BH")

dietVendor_pvalue <- pretty_pvalue(pairwise_results = dietVendor_pairwise)
```

idk why i didn't just run normal stats on this data bc I don't need the surminer package to do them 
```{r}
dietVendor_stat_list <- kruskal_dunn_stats(input_table = surv_table,
                                           grouped_by = c("diet"),
                                           adjust_method = "BH",
                                           filter_adj_p_value = FALSE,
                                           formula_left = "actual_surv",
                                           formula_right = "vendor")

dietVendor_kruskal <- dietVendor_stat_list$KruskalTest
dietVendor_dunn <- dietVendor_stat_list$DunnTest

dietVendor_dunn
```


```{r}
## just overall diet stats
diet_pairwise <- pairwise_survdiff(formula = Surv(day_post_inf, actual_surv) ~ diet,
                                   data = surv_table,
                                   p.adjust.method = "BH")

diet_pvalue <- pretty_pvalue(pairwise_results = diet_pairwise)
```

```{r}
## diet and experiment stats
dietExp_pairwise <- pairwise_survdiff(formula = Surv(day_post_inf, actual_surv) ~ diet + experiment,
                                      data = surv_table,
                                      p.adjust.method = "BH")

dietExp_pvalue <- pretty_pvalue(pairwise_results = dietExp_pairwise)
```

```{r}
## experiment and vendor stats
expVendor_pairwise <- pairwise_survdiff(formula = Surv(day_post_inf, actual_surv) ~ experiment + vendor,
                                         data = surv_table,
                                         p.adjust.method = "BH")

expVendor_pvalue <- pretty_pvalue(pairwise_results = expVendor_pairwise)
```

**Saving my Outputs**
```{r}
## plots
ggsave('../plots/dietVendor_survival.pdf',
       plot = dietVendor_plot,
       width = 17,
       height = 7)
ggsave('../plots/dietExp_survival.pdf',
       plot = dietExp_plot,
       width = 17,
       height = 7)
ggsave('../plots/experimentVendor_survival.pdf',
       plot = expVendor_plot,
       width = 10,
       height = 6)

## stats
write_tsv(dietVendor_pvalue,
          '../stats/surv_dietVendor.tsv')
write_tsv(dietVendor_dunn,
          '../stats/surv_dietVendor_dunn.tsv')
write_tsv(diet_pvalue,
          '../stats/surv_diet.tsv')
write_tsv(dietExp_pvalue,
          '../stats/surv_dietExp.tsv')
write_tsv(expVendor_pvalue,
          '../stats/surv_expVendor.tsv')
```

