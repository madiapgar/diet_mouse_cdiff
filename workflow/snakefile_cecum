rule target:
    input:
        "data/cecal_qiime/SEQ069/s69_demux.qza",
        "data/cecal_qiime/SEQ069/s69_demux_details.qza",
        "data/cecal_qiime/SEQ069/s69_demux.qzv",
        "data/cecal_qiime/SEQ070/s70_demux.qza",
        "data/cecal_qiime/SEQ070/s70_demux_details.qza",
        "data/cecal_qiime/SEQ070/s70_demux.qzv",
        "data/cecal_qiime/SEQ071/s71_demux.qza",
        "data/cecal_qiime/SEQ071/s71_demux_details.qza",
        "data/cecal_qiime/SEQ071/s71_demux.qzv",
        "data/cecal_qiime/SEQ069/s69_table.qza",
        "data/cecal_qiime/SEQ069/s69_rep_seqs.qza",
        "data/cecal_qiime/SEQ069/s69_denoise_stats.qza",
        "data/cecal_qiime/SEQ070/s70_table.qza",
        "data/cecal_qiime/SEQ070/s70_rep_seqs.qza",
        "data/cecal_qiime/SEQ070/s70_denoise_stats.qza",
        "data/cecal_qiime/SEQ071/s71_table.qza",
        "data/cecal_qiime/SEQ071/s71_rep_seqs.qza",
        "data/cecal_qiime/SEQ071/s71_denoise_stats.qza",
        "data/cecal_qiime/all_cecal_table.qza",
        "data/cecal_qiime/all_cecal_rep_seqs.qza",
        "data/cecal_qiime/tree.qza",
        "data/cecal_qiime/placements.qza",
        "data/cecal_qiime/filt_cecal_table.qza",
        "data/cecal_qiime/rem_cecal_table.qza",
        "data/cecal_qiime/taxonomy.qza",
        "data/cecal_qiime/taxonomy_filtered.qza",
        "data/cecal_qiime/taxonomy_filtered.qzv",
        "data/cecal_qiime/lacto_cecal_table.qza",
        "data/cecal_qiime/lacto_rep_seqs.qza"


rule seq069_demultiplex:
    input:
        "data/cecal_qiime/SEQ069/cecal_s69_barcodes.txt",
        "data/cecal_qiime/SEQ069/s69_paired_end_seqs.qza"
    output:
        "data/cecal_qiime/SEQ069/s69_demux.qza",
        "data/cecal_qiime/SEQ069/s69_demux_details.qza",
        "data/cecal_qiime/SEQ069/s69_demux.qzv"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime demux emp-paired \
            --m-barcodes-file ./data/cecal_qiime/SEQ069/cecal_s69_barcodes.txt \
            --m-barcodes-column BarcodeSequence \
            --i-seqs ./data/cecal_qiime/SEQ069/s69_paired_end_seqs.qza \
            --o-per-sample-sequences ./data/cecal_qiime/SEQ069/s69_demux.qza \
            --o-error-correction-details ./data/cecal_qiime/SEQ069/s69_demux_details.qza \
            --p-no-golay-error-correction
        
        qiime demux summarize \
            --i-data ./data/cecal_qiime/SEQ069/s69_demux.qza \
            --o-visualization ./data/cecal_qiime/SEQ069/s69_demux.qzv
        """


rule seq070_demultiplex:
    input:
        "data/cecal_qiime/SEQ070/cecal_s70_barcodes.txt",
        "data/cecal_qiime/SEQ070/s70_paired_end_seqs.qza"
    output:
        "data/cecal_qiime/SEQ070/s70_demux.qza",
        "data/cecal_qiime/SEQ070/s70_demux_details.qza",
        "data/cecal_qiime/SEQ070/s70_demux.qzv"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime demux emp-paired \
            --m-barcodes-file ./data/cecal_qiime/SEQ070/cecal_s70_barcodes.txt \
            --m-barcodes-column BarcodeSequence \
            --i-seqs ./data/cecal_qiime/SEQ070/s70_paired_end_seqs.qza \
            --o-per-sample-sequences ./data/cecal_qiime/SEQ070/s70_demux.qza \
            --o-error-correction-details ./data/cecal_qiime/SEQ070/s70_demux_details.qza \
            --p-no-golay-error-correction
        
        qiime demux summarize \
            --i-data ./data/cecal_qiime/SEQ070/s70_demux.qza \
            --o-visualization ./data/cecal_qiime/SEQ070/s70_demux.qzv
        """


rule seq071_demultiplex:
    input:
        "data/cecal_qiime/SEQ071/cecal_s71_barcodes.txt",
        "data/cecal_qiime/SEQ071/s71_paired_end_seqs.qza"
    output:
        "data/cecal_qiime/SEQ071/s71_demux.qza",
        "data/cecal_qiime/SEQ071/s71_demux_details.qza",
        "data/cecal_qiime/SEQ071/s71_demux.qzv"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime demux emp-paired \
            --m-barcodes-file ./data/cecal_qiime/SEQ071/cecal_s71_barcodes.txt \
            --m-barcodes-column BarcodeSequence \
            --i-seqs ./data/cecal_qiime/SEQ071/s71_paired_end_seqs.qza \
            --o-per-sample-sequences ./data/cecal_qiime/SEQ071/s71_demux.qza \
            --o-error-correction-details ./data/cecal_qiime/SEQ071/s71_demux_details.qza \
            --p-no-golay-error-correction

        qiime demux summarize \
            --i-data ./data/cecal_qiime/SEQ071/s71_demux.qza \
            --o-visualization ./data/cecal_qiime/SEQ071/s71_demux.qzv
        """

## do all three runs need to be trimmed/truncated at the same place bc they will be joined together later? - yes!
rule seq069_dada2:
    input:
        "data/cecal_qiime/SEQ069/s69_demux.qza"
    output:
        "data/cecal_qiime/SEQ069/s69_table.qza",
        "data/cecal_qiime/SEQ069/s69_rep_seqs.qza",
        "data/cecal_qiime/SEQ069/s69_denoise_stats.qza"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime dada2 denoise-paired \
            --i-demultiplexed-seqs ./data/cecal_qiime/SEQ069/s69_demux.qza \
            --p-trim-left-f 13 \
            --p-trim-left-r 13 \
            --p-trunc-len-f 200 \
            --p-trunc-len-r 227 \
            --o-table ./data/cecal_qiime/SEQ069/s69_table.qza \
            --o-representative-sequences ./data/cecal_qiime/SEQ069/s69_rep_seqs.qza \
            --o-denoising-stats ./data/cecal_qiime/SEQ069/s69_denoise_stats.qza
        """


rule seq070_dada2:
    input:
        "data/cecal_qiime/SEQ070/s70_demux.qza"
    output:
        "data/cecal_qiime/SEQ070/s70_table.qza",
        "data/cecal_qiime/SEQ070/s70_rep_seqs.qza",
        "data/cecal_qiime/SEQ070/s70_denoise_stats.qza"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime dada2 denoise-paired \
            --i-demultiplexed-seqs ./data/cecal_qiime/SEQ070/s70_demux.qza \
            --p-trim-left-f 13 \
            --p-trim-left-r 13 \
            --p-trunc-len-f 200 \
            --p-trunc-len-r 227 \
            --o-table ./data/cecal_qiime/SEQ070/s70_table.qza \
            --o-representative-sequences ./data/cecal_qiime/SEQ070/s70_rep_seqs.qza \
            --o-denoising-stats ./data/cecal_qiime/SEQ070/s70_denoise_stats.qza
        """


rule seq071_dada2:
    input:
        "data/cecal_qiime/SEQ071/s71_demux.qza"
    output:
        "data/cecal_qiime/SEQ071/s71_table.qza",
        "data/cecal_qiime/SEQ071/s71_rep_seqs.qza",
        "data/cecal_qiime/SEQ071/s71_denoise_stats.qza"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime dada2 denoise-paired \
            --i-demultiplexed-seqs ./data/cecal_qiime/SEQ071/s71_demux.qza \
            --p-trim-left-f 13 \
            --p-trim-left-r 13 \
            --p-trunc-len-f 200 \
            --p-trunc-len-r 227 \
            --o-table ./data/cecal_qiime/SEQ071/s71_table.qza \
            --o-representative-sequences ./data/cecal_qiime/SEQ071/s71_rep_seqs.qza \
            --o-denoising-stats ./data/cecal_qiime/SEQ071/s71_denoise_stats.qza
        """


rule merge_run_tables:
    input:
        "data/cecal_qiime/SEQ069/s69_table.qza",
        "data/cecal_qiime/SEQ070/s70_table.qza",
        "data/cecal_qiime/SEQ071/s71_table.qza",
        "data/cecal_qiime/SEQ069/s69_rep_seqs.qza",
        "data/cecal_qiime/SEQ070/s70_rep_seqs.qza",
        "data/cecal_qiime/SEQ071/s71_rep_seqs.qza"
    output:
        "data/cecal_qiime/all_cecal_table.qza",
        "data/cecal_qiime/all_cecal_rep_seqs.qza"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime feature-table merge \
            --i-tables ./data/cecal_qiime/SEQ069/s69_table.qza \
            --i-tables ./data/cecal_qiime/SEQ070/s70_table.qza \
            --i-tables ./data/cecal_qiime/SEQ071/s71_table.qza \
            --o-merged-table ./data/cecal_qiime/all_cecal_table.qza

        qiime feature-table merge-seqs \
            --i-data ./data/cecal_qiime/SEQ069/s69_rep_seqs.qza \
            --i-data ./data/cecal_qiime/SEQ070/s70_rep_seqs.qza \
            --i-data ./data/cecal_qiime/SEQ071/s71_rep_seqs.qza \
            --o-merged-data ./data/cecal_qiime/all_cecal_rep_seqs.qza
        """


rule get_reference_databases:
    output:
        "databases/sepp-refs-silva-128.qza",
        "databases/silva-138-99-515-806-nb-classifier.qza"
    shell:
        """
        wget https://data.qiime2.org/2023.5/common/sepp-refs-silva-128.qza -P ./databases/
        wget https://data.qiime2.org/2023.5/common/silva-138-99-515-806-nb-classifier.qza -P ./databases/
        """


rule sepp_phylo_tree:
    input:
        "data/cecal_qiime/all_cecal_rep_seqs.qza",
        "databases/sepp-refs-silva-128.qza"
    output:
        "data/cecal_qiime/tree.qza",
        "data/cecal_qiime/placements.qza"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime fragment-insertion sepp \
            --i-representative-sequences ./data/cecal_qiime/all_cecal_rep_seqs.qza \
            --i-reference-database ./databases/sepp-refs-silva-128.qza \
            --o-tree ./data/cecal_qiime/tree.qza \
            --o-placements ./data/cecal_qiime/placements.qza
        """


rule sepp_ASV_filtering:
    input:
        "data/cecal_qiime/all_cecal_table.qza",
        "data/cecal_qiime/tree.qza"
    output:
        "data/cecal_qiime/filt_cecal_table.qza",
        "data/cecal_qiime/rem_cecal_table.qza"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime fragment-insertion filter-features \
            --i-table ./data/cecal_qiime/all_cecal_table.qza \
            --i-tree ./data/cecal_qiime/tree.qza \
            --o-filtered-table ./data/cecal_qiime/filt_cecal_table.qza \
            --o-removed-table ./data/cecal_qiime/rem_cecal_table.qza
        """


rule taxonomic_classification:
    input:
        "databases/silva-138-99-515-806-nb-classifier.qza",
        "data/cecal_qiime/all_cecal_rep_seqs.qza"
    output:
        "data/cecal_qiime/taxonomy.qza"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime feature-classifier classify-sklearn \
            --i-classifier ./databases/silva-138-99-515-806-nb-classifier.qza \
            --i-reads ./data/cecal_qiime/all_cecal_rep_seqs.qza \
            --o-classification ./data/cecal_qiime/taxonomy.qza
        """


rule filter_taxonomy:
    input:
        "data/cecal_qiime/filt_cecal_table.qza",
        "data/cecal_qiime/taxonomy.qza"
    output:
        "data/cecal_qiime/taxonomy_filtered.qza",
        "data/cecal_qiime/taxonomy_filtered.qzv"
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime taxa filter-table \
            --i-table ./data/cecal_qiime/filt_cecal_table.qza \
            --i-taxonomy ./data/cecal_qiime/taxonomy.qza \
            --p-include p_ \
            --p-exclude mitochondria,chloroplast \
            --o-filtered-table ./data/cecal_qiime/taxonomy_filtered.qza
        
        qiime feature-table summarize \
            --i-table ./data/cecal_qiime/taxonomy_filtered.qza \
            --o-visualization ./data/cecal_qiime/taxonomy_filtered.qzv
        """

## from here on, this will follow the same steps as the colon pipeline (depending on the lactococccus contam)
## convert rep-seqs to a fasta file for total sum scaling?? - yes, do this
rule create_lacto_table:
    input:
        "data/cecal_qiime/filt_cecal_table.qza",
        "data/cecal_qiime/taxonomy.qza",
        "data/cecal_qiime/all_cecal_rep_seqs.qza",
        "data/cecal_qiime/lacto_cecal_table.qza"
    output:
        "data/cecal_qiime/lacto_cecal_table.qza",
        "data/cecal_qiime/lacto_rep_seqs.qza" 
    conda:
        "qiime2-2023.5"
    shell:
        """
        qiime taxa filter-table \
            --i-table ./data/cecal_qiime/filt_cecal_table.qza \
            --i-taxonomy ./data/cecal_qiime/taxonomy.qza \
            --p-include Lactococcus \
            --o-filtered-table ./data/cecal_qiime/lacto_cecal_table.qza
        
        qiime feature-table filter-seqs \
            --i-data ./data/cecal_qiime/all_cecal_rep_seqs.qza \
            --i-table ./data/cecal_qiime/lacto_cecal_table.qza \
            --o-filtered-data ./data/cecal_qiime/lacto_rep_seqs.qza
        """